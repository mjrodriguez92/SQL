USE p_REP_LIBRE_MDS
GO

DROP TABLE #TMP
GO

DROP TABLE #T
GO

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


CREATE TABLE #TMP
(
	UnitSN varchar(200)
)

INSERT INTO #TMP SELECT 'L1B1201008900014210038355D'
INSERT INTO #TMP SELECT 'L1B12010089000142100383558'
INSERT INTO #TMP SELECT 'L1B12010089000142100383555'
INSERT INTO #TMP SELECT 'L1B1201009900014210039503C'
INSERT INTO #TMP SELECT 'L1B12010099000142100395034'
INSERT INTO #TMP SELECT 'L1B12010089000142100383554'
INSERT INTO #TMP SELECT 'L1B12010099000142100395031'
INSERT INTO #TMP SELECT 'L1B1201008900014210038308A'
INSERT INTO #TMP SELECT 'L1B12010089000142100383425'
INSERT INTO #TMP SELECT 'L1B1201008900014210038315C'
INSERT INTO #TMP SELECT 'L1B12010089000142100383159'
INSERT INTO #TMP SELECT 'L1B12010099000142100395033'
INSERT INTO #TMP SELECT 'L1B1201008900014210038308F'
INSERT INTO #TMP SELECT 'L1B12010099000142100395092'
INSERT INTO #TMP SELECT 'L1B12010089000142100383424'
INSERT INTO #TMP SELECT 'L1B12010099000142100395037'
INSERT INTO #TMP SELECT 'L1B12010089000142100383085'
INSERT INTO #TMP SELECT 'L1B12010089000142100383080'
INSERT INTO #TMP SELECT 'L1B1201009900014210039509F'
INSERT INTO #TMP SELECT 'L1B12010099000142100395070'
INSERT INTO #TMP SELECT 'L1B12010089000142100383158'
INSERT INTO #TMP SELECT 'L1B12010089000142100383157'
INSERT INTO #TMP SELECT 'L1B12010099000142100395036'
INSERT INTO #TMP SELECT 'L1B1201008900014210038308E'
INSERT INTO #TMP SELECT 'L1B1201008900014210038308B'
INSERT INTO #TMP SELECT 'L1B1201008900014210038315D'
INSERT INTO #TMP SELECT 'L1B12010089000142100383421'
INSERT INTO #TMP SELECT 'L1B12010089000142100383156'
INSERT INTO #TMP SELECT 'L1B12010089000142100383150'
INSERT INTO #TMP SELECT 'L1B1201009900014210039509E'
INSERT INTO #TMP SELECT 'L1B1201009900014210039503A'
INSERT INTO #TMP SELECT 'L1B1201009900014210039509B'
INSERT INTO #TMP SELECT 'L1B1201009900014210039507A'
INSERT INTO #TMP SELECT 'L1B1201009900014210039509C'
INSERT INTO #TMP SELECT 'L1B1201009900014210039509D'
INSERT INTO #TMP SELECT 'L1B1201009900014210039503B'
INSERT INTO #TMP SELECT 'L1B1201008900014210038308C'
INSERT INTO #TMP SELECT 'L1B12010099000142100395075'
INSERT INTO #TMP SELECT 'L1B12010089000142100383087'
INSERT INTO #TMP SELECT 'L1B12010099000142100395077'
INSERT INTO #TMP SELECT 'L1B12010099000142100395099'
INSERT INTO #TMP SELECT 'L1B12010099000142100395038'
INSERT INTO #TMP SELECT 'L1B1201008900014210038308D'
INSERT INTO #TMP SELECT 'L1B12010089000142100383152'
INSERT INTO #TMP SELECT 'L1B12010089000142100383153'
INSERT INTO #TMP SELECT 'L1B12010099000142100395035'
INSERT INTO #TMP SELECT 'L1B12010099000142100395074'
INSERT INTO #TMP SELECT 'L1B12010089000142100383089'
INSERT INTO #TMP SELECT 'L1B12010099000142100395078'
INSERT INTO #TMP SELECT 'L1B12010089000142100383088'
INSERT INTO #TMP SELECT 'L1B1201009900014210039507B'
INSERT INTO #TMP SELECT 'L1B12010089000142100383084'
INSERT INTO #TMP SELECT 'L1B1201008900014210038315B'
INSERT INTO #TMP SELECT 'L1B12010089000142100383086'
INSERT INTO #TMP SELECT 'L1B1201008900014210038315A'
INSERT INTO #TMP SELECT 'L1B1201008900014210038315E'
INSERT INTO #TMP SELECT 'L1B1201008900014210038315F'
INSERT INTO #TMP SELECT 'L1B1201009900014210039503E'
INSERT INTO #TMP SELECT 'L1B12010089000142100383420'
INSERT INTO #TMP SELECT 'L1B12010099000142100395096'
INSERT INTO #TMP SELECT 'L1B12010099000142100395093'
INSERT INTO #TMP SELECT 'L1B12010099000142100395032'
INSERT INTO #TMP SELECT 'L1B12010099000142100395072'
INSERT INTO #TMP SELECT 'L1B12010099000142100395090'
INSERT INTO #TMP SELECT 'L1B12010089000142100383082'
INSERT INTO #TMP SELECT 'L1B12010089000142100383151'
INSERT INTO #TMP SELECT 'L1B1201009900014210039503D'
INSERT INTO #TMP SELECT 'L1B1201009900014210039507C'
INSERT INTO #TMP SELECT 'L1B12010099000142100395095'
INSERT INTO #TMP SELECT 'L1B1201009900014210039507F'
INSERT INTO #TMP SELECT 'L1B12010089000142100383083'
INSERT INTO #TMP SELECT 'L1B1201008900014210038355E'
INSERT INTO #TMP SELECT 'L1B1201008900014210038355F'
INSERT INTO #TMP SELECT 'L1B12010089000142100383559'
INSERT INTO #TMP SELECT 'L1B1201008900014210038355A'

--SELECT count(*) FROM #TMP

;WITH Unit AS(
	SELECT Unit.Unit_Id, Unit.SerialNumber, Unit.PartNumber_Id, Unit.Workorder_Id, Unit.ParentUnit_Id, Unit.SampleUnit, Unit.CreateDttm
	FROM DS_FT_Unit Unit WITH(nolock)
	INNER JOIN #TMP t ON Unit.SerialNumber = t.UnitSN
	--WHERE Unit.SerialNumber IN 
	--('L1B1201006900014070008978E')
)


SELECT 
	Unit.SerialNumber,
	SPITest.TestResult SPITestResult,
	AOITest.TestResult AOITestResult,
	CASE WHEN LEFT (Unit.SerialNumber,2) != 'L2' THEN 'NA' ELSE CAST(RFTest.TestResult AS varchar(1)) END RFTestResult,
	FCTest.TestResult FCTestResult,
	CASE WHEN (tray.trayResult IS NULL) THEN 0 ELSE 1 END TraySorterTest,
	f.FileName SPIFileName,
	AOITest.TestEndDate AOITestEndDate,  ff.FileName AOIFileName,
	CASE WHEN LEFT (Unit.SerialNumber,2) != 'L2' THEN 'NA' ELSE CONVERT(varchar(20),RFTest.TestEndDate,121) END RFTestEndDate,  
	CASE WHEN LEFT (Unit.SerialNumber,2) != 'L2' THEN 'NA' ELSE ffff.FileName END RFFileName,
	FCTest.TestEndDate FCTestEndDate,  fff.FileName FCFileName,
	ftray.FileName TraySorterFileName
INTO #T
FROM Unit 
LEFT JOIN [dbo].[DS_FT_SPITest] SPITest WITH(nolock) on Unit.Unit_Id = SPITest.UNit_Id
LEFT JOIN [dbo].[Log_InFileProcess] f WITH(nolock) ON f.[InFileProcess_Id] = SPITest.InFileProcess_Id
LEFT JOIN [dbo].[DS_FT_AOITest] AOITest WITH(nolock) ON Unit.Unit_Id = AOITest.UNit_Id
LEFT JOIN [dbo].[Log_InFileProcess] ff WITH(nolock) ON ff.[InFileProcess_Id] = AOITest.InFileProcess_Id
LEFT JOIN DS_FT_FCTest FCTest WITH(nolock) on Unit.Unit_Id = FCTest.UNit_Id
LEFT JOIN [dbo].[Log_InFileProcess] fff WITH(nolock) ON fff.[InFileProcess_Id] = FCTest.InFileProcess_Id
LEFT JOIN [dbo].[DS_FT_RFTest] RFTest WITH(nolock) ON Unit.Unit_Id = RFTest.UNit_Id
LEFT JOIN [dbo].[Log_InFileProcess] ffff WITH(nolock) ON ffff.[InFileProcess_Id] = RFTest.InFileProcess_Id
LEFT JOIN
(
	SELECT 
		tray.Unit_Id, 
		tray.a+tray.b+tray.c+tray.d+tray.e+	isnull(tray.f,0)+isnull(tray.g,0)+ tray.h trayResult
	FROM
	(
		SELECT 
			t.Unit_Id, 
			sum(CAST(ts.AckFlag as INT))-COUNT(*) a,
			sum(CAST(SPITest.TestResult as INT))-COUNT(*) b,
			sum(CAST(SPITest.AckFlag as INT))-COUNT(*) c,
			sum(CAST(AOITest.TestResult as INT))-COUNT(*) d,
			sum(CAST(AOITest.AckFlag as INT))-COUNT(*) e,
			sum(CAST(RFTest.TestResult as INT))-COUNT(*) f,
			sum(CAST(RFTest.AckFlag as INT))-COUNT(*) g,
			sum(CAST(FCTest.TestResult as INT))-COUNT(*) h
		FROM DS_FT_TraySorter ts WITH(nolock)
		INNER JOIN
		(
			select Unit.Unit_Id, InFileProcess_Id
			from Unit
			INNER JOIN DS_FT_TraySorter tray WITH(nolock) on tray.Unit_Id=Unit.Unit_Id
		)t ON t.InFileProcess_Id =  ts.InFileProcess_Id
		INNER JOIN [dbo].[DS_FT_SPITest] SPITest WITH(nolock) on ts.Unit_Id = SPITest.UNit_Id
		INNER JOIN [dbo].[DS_FT_AOITest] AOITest WITH(nolock) ON ts.Unit_Id = AOITest.UNit_Id
		INNER JOIN DS_FT_FCTest FCTest WITH(nolock) on ts.Unit_Id = FCTest.UNit_Id
		LEFT JOIN [dbo].[DS_FT_RFTest] RFTest WITH(nolock) ON ts.Unit_Id = RFTest.UNit_Id
		GROUP BY t.Unit_Id
	)tray
)tray on tray.Unit_Id = Unit.Unit_Id
	left JOIN DS_FT_TraySorter tray2 WITH(nolock) on tray2.Unit_Id=Unit.Unit_Id
	left JOIN [dbo].[Log_InFileProcess] ftray WITH(nolock) ON tray2.[InFileProcess_Id] = ftray.InFileProcess_Id


SELECT *
FROM #T

--TraySorter
SELECT '-' + SerialNumber + ' > ' + ISNULL(TraySorterFileName, 'No file')
FROM #T
