SELECT
--po.ProductionOrderNumber WO
c.SerialNumber CartID
,tsn.value TraySN
--,usn.Value
--,u.ID UnitID
,sn.value UnitSN
--,u.StatusID UnitStatusID
--,us.Description UnitStatus
--,u.UnitStateID
--,ust.Description UnitState
--,mu.SerialNumber
--,mu.ID
INTO #UnitsTrayCart 
FROM ffProductionOrder po WITH(nolock)
INNER JOIN ffUnit u WITH(nolock) ON po.ID = u.ProductionOrderID
INNER JOIN luUnitStatus us WITH(nolock) ON u.StatusId = us.ID
INNER JOIN ffUnitState ust WITH(nolock) ON u.UnitStateID = ust.ID
INNER JOIN ffSerialNumber sn WITH(nolock) ON u.PanelID = sn.UnitID 
INNER JOIN ffSerialNumber tsn WITH(nolock) ON u.PanelID = tsn.UnitID
left outer join ffSerialNumber usn with(nolock) on usn.UnitID = u.ID and usn.SerialNumberTypeID = 3
LEFT OUTER JOIN udtTray t WITH(nolock) ON u.PanelID = t.UnitID
LEFT OUTER JOIN udtCart c WITH(nolock) ON t.CartID = c.ID
--LEFT OUTER JOIN ffMaterialUnit mu with(nolock) on c.MaterialUnitID = mu.ID
WHERE po.ProductionOrderNumber = 'C5B001379'


Select * from #UnitsTrayCart utc

DROP TABLE #UnitsTrayCart 





-- Trays, Carts Consumed 
SELECT Distinct tpo.ProductionOrderNumber ContainerWO ,c.SerialNumber, tsn.Value Tray, csn.Value ContainerSN
FROM udtTrayHistory th WITH(nolock)
LEFT OUTER JOIN udtCart c WITH(nolock) ON th.CartID = c.ID
INNER JOIN ffProductionOrder tpo WITH(nolock) ON th.ProductionOrderID = tpo.ID
INNER JOIN ffUnit u WITH(nolock) ON tpo.ID = u.ProductionOrderID
INNER JOIN ffSerialNumber tsn WITH(nolock) ON u.PanelID = tsn.UnitID
INNER JOIN ffSerialNumber csn WITH(nolock) ON u.ID = csn.UnitID AND  csn.SerialNumberTypeID = 0
Where tpo.ProductionOrderNumber = 'C5B001379'
group by tpo.ProductionOrderNumber, c.SerialNumber, tsn.Value, csn.Value
Order by tpo.ProductionOrderNumber 

-- Trying to get carts for C5B001379 joined to table above
Select Distinct c.SerialNumber --csn.Value ContainerSN, --tpo.ProductionOrderNumber ContainerWO , tsn.Value Tray
from udtCartHistory ch with(nolock)
Left Outer JOIN udtCart c WITH(nolock) ON ch.CartID = c.ID

--INNER JOIN ffProductionOrder tpo WITH(nolock) ON c.ProductionOrderID = tpo.ID
--Left Outer JOIN udtTrayHistory th with(nolock) ON tpo.ID = th.ProductionOrderID
--INNER JOIN ffUnit u WITH(nolock) ON tpo.ID = u.ProductionOrderID
--INNER JOIN ffSerialNumber tsn WITH(nolock) ON u.PanelID = tsn.UnitID
--INNER JOIN ffSerialNumber csn WITH(nolock) ON u.ID = csn.UnitID AND  csn.SerialNumberTypeID = 0
--Where tpo.ProductionOrderNumber = 'C5B001379'
--group by tpo.ProductionOrderNumber, c.SerialNumber, tsn.Value, csn.Value
--Order by tpo.ProductionOrderNumber 

where ch.ProductionOrderID = 10903





--Sensors Used and Balance
select o.ProductionOrderNumber, l.Description, l.Location, o.ActualStartTime, o.ActualFinishTime, lo.LineQuantity, lo.ReadyQuantity, sd.LotCode, 
(cast(sd.LastSensorSerial as bigint)) - cast(sd.FirstSensorSerial as bigint) ReelTotal,  count(u.ID) TotalUsed,
(cast(sd.LastSensorSerial as bigint)) - cast(sd.FirstSensorSerial as bigint) - count(u.ID) BalanceQty,
mud.Reserved_13
  from ffUnit u
  join ffProductionOrder o on u.ProductionOrderID = o.ID
  --left join ffMaterialUnitDetail mud with(nolock) on mud.Reserved_04 = po.ProductionOrderNumber
  LEFT OUTER JOIN udtTray t WITH(nolock) ON u.PanelID = t.UnitID
  LEFT OUTER JOIN udtCart c WITH(nolock) ON t.CartID = c.ID
  join ffLineOrder lo with(nolock) on o.ID = lo.ProductionOrderID
  join ffpart p with(nolock) on o.PartID = p.ID
  join ffline l with(nolock) on lo.LineID = l.id
  join ffSerialNumber sn on u.ID = sn.UnitID and sn.SerialNumberTypeID = 0
  join udtSensorSerials ss on sn.Value = ss.Serial 
  join udtSensorData sd on ss.SensorDataID = sd.ID 
 where o.ProductionOrderNumber in ('C5B001379')


'C5B000727',
'C5B000728',
'C5B000729',
'C5B000730',
'C5B000731',
'C5B000732',
'C5B000733',
'C5B000734',
'C5B000735',
'C5B000736',
'C5B000737',
'C5B000738',
'C5B000739',
'C5B000740',
'C5B000741',
'C5B000742',
'C5B000743',
'C5B000744',
'C5B000745',
'C5B000746',
'C5B000747',
'C5B000748',
'C5B000749',
'C5B000750',
'C5B000751',
'C5B000752',
'C5B000753',
'C5B000754',
'C5B000755',
'C5B000756',
'C5B000757',
'C5B000758',
'C5B000759',
'C5B000760',
'C5B000761',
'C5B000762',
'C5B000763',
'C5B000764',
'C5B000765',
'C5B000766',
'C5B000767',
'C5B000768',
'C5B000769',
'C5B000770',
'C5B000771',
'C5B000772',
'C5B000773',
'C5B000774',
'C5B000775',
'C5B000776',
'C5B000777',
'C5B000778',
'C5B000779',
'C5B000780',
'C5B000781',
'C5B000783',
'C5B000784',
'C5B000785',
'C5B000786',
'C5B000788',
'C5B000789',
'C5B000790',
'C5B000791',
'C5B000792',
'C5B000793',
'C5B000794',
'C5B000795',
'C5B000796',
'C5B000797',
'C5B000798',
'C5B000799',
'C5B000800',
'C5B000801',
'C5B000802',
'C5B000803',
'C5B000804',
'C5B000805',
'C5B000806',
'C5B000807',
'C5B000808',
'C5B000809',
'C5B000810',
'C5B000811',
'C5B000812',
'C5B000813',
'C5B000814',
'C5B000815',
'C5B000816',
'C5B000817',
'C5B000818',
'C5B000819',
'C5B000820',
'C5B000821',
'C5B000822',
'C5B000823',
'C5B000825',
'C5B000826',
'C5B000830',
'C5B000834',
'C5B000835',
'C5B000842',
'C5B000843',
'C5B000844',
'C5B000845',
'C5B000846',
'C5B000847',
'C5B000849',
'C5B000850',
'C5B000851',
'C5B000852',
'C5B000853',
'C5B000854',
'C5B000855',
'C5B000856',
'C5B000857',
'C5B000858',
'C5B000859',
'C5B000860',
'C5B000861',
'C5B000862',
'C5B000863',
'C5B000864',
'C5B000865',
'C5B000866',
'C5B000867',
'C5B000868',
'C5B000869',
'C5B000870',
'C5B000872',
'C5B000873',
'C5B000875',
'C5B000876',
'C5B000877',
'C5B000878',
'C5B000879',
'C5B000880',
'C5B000881',
'C5B000882',
'C5B000883',
'C5B000884',
'C5B000885',
'C5B000886',
'C5B000887',
'C5B000888',
'C5B000889',
'C5B000890',
'C5B000891',
'C5B000892',
'C5B000893',
'C5B000894',
'C5B000896',
'C5B000897',
'C5B000899',
'C5B000900',
'C5B000901',
'C5B000905',
'C5B000906',
'C5B000907',
'C5B000908',
'C5B000913',
'C5B000922',
'C5B000926',
'C5B000928',
'C5B000929',
'C5B000930',
'C5B000931',
'C5B000932',
'C5B000933',
'C5B000934',
'C5B000935',
'C5B000936',
'C5B000937',
'C5B000938',
'C5B000939',
'C5B000940',
'C5B000941',
'C5B000943',
'C5B000944',
'C5B000945',
'C5B000946',
'C5B000947',
'C5B000948',
'C5B000949',
'C5B000950',
'C5B000952',
'C5B000953',
'C5B000954',
'C5B000955',
'C5B000956',
'C5B000957',
'C5B000958',
'C5B000959',
'C5B000960',
'C5B000961',
'C5B000962',
'C5B000963',
'C5B000964',
'C5B000965',
'C5B000966',
'C5B000967',
'C5B000968',
'C5B000969',
'C5B000970',
'C5B000971',
'C5B000972',
'C5B000973',
'C5B000974',
'C5B000975',
'C5B000976',
'C5B000977',
'C5B000978',
'C5B000979',
'C5B000980',
'C5B000981',
'C5B000982',
'C5B000983',
'C5B000984',
'C5B000985',
'C5B000986',
'C5B000987',
'C5B000988',
'C5B000989',
'C5B000993',
'C5B000994',
'C5B001002',
'C5B001006',
'C5B001007',
'C5B001008',
'C5B001009',
'C5B001010',
'C5B001011',
'C5B001012',
'C5B001013',
'C5B001014',
'C5B001015',
'C5B001016',
'C5B001017',
'C5B001018',
'C5B001019',
'C5B001020',
'C5B001022',
'C5B001023',
'C5B001024',
'C5B001025',
'C5B001027',
'C5B001029',
'C5B001030',
'C5B001031',
'C5B001035',
'C5B001036',
'C5B001041',
'C5B001043',
'C5B001044',
'C5B001045',
'C5B001046',
'C5B001047',
'C5B001051',
'C5B001052',
'C5B001053',
'C5B001054',
'C5B001055',
'C5B001056',
'C5B001057',
'C5B001058',
'C5B001059',
'C5B001060',
'C5B001062',
'C5B001063',
'C5B001064',
'C5B001065',
'C5B001066',
'C5B001067',
'C5B001068',
'C5B001069',
'C5B001070',
'C5B001071',
'C5B001072',
'C5B001073',
'C5B001074',
'C5B001075',
'C5B001077',
'C5B001078',
'C5B001079',
'C5B001080',
'C5B001081',
'C5B001082',
'C5B001083',
'C5B001085',
'C5B001086',
'C5B001087',
'C5B001088',
'C5B001089',
'C5B001091',
'C5B001092',
'C5B001095',
'C5B001096',
'C5B001097',
'C5B001098',
'C5B001099',
'C5B001100',
'C5B001102',
'C5B001103',
'C5B001104',
'C5B001105',
'C5B001107',
'C5B001108',
'C5B001109',
'C5B001110',
'C5B001111',
'C5B001112',
'C5B001113',
'C5B001116',
'C5B001117',
'C5B001118',
'C5B001119',
'C5B001120',
'C5B001129',
'C5B001130',
'C5B001131',
'C5B001132',
'C5B001133',
'C5B001134',
'C5B001139',
'C5B001140',
'C5B001141',
'C5B001142',
'C5B001143',
'C5B001148',
'C5B001150',
'C5B001152',
'C5B001153',
'C5B001154',
'C5B001156',
'C5B001158',
'C5B001159',
'C5B001160',
'C5B001161',
'C5B001162',
'C5B001163',
'C5B001164',
'C5B001165',
'C5B001166',
'C5B001167',
'C5B001168',
'C5B001169',
'C5B001170',
'C5B001171',
'C5B001172',
'C5B001173',
'C5B001174',
'C5B001175',
'C5B001176',
'C5B001177',
'C5B001178',
'C5B001179',
'C5B001180',
'C5B001182',
'C5B001183',
'C5B001184',
'C5B001186',
'C5B001189',
'C5B001190',
'C5B001191',
'C5B001192',
'C5B001193',
'C5B001196',
'C5B001197',
'C5B001198',
'C5B001199',
'C5B001200',
'C5B001201',
'C5B001202',
'C5B001203',
'C5B001214',
'C5B001215',
'C5B001216',
'C5B001217',
'C5B001219',
'C5B001220',
'C5B001221',
'C5B001224',
'C5B001227',
'C5B001228',
'C5B001229',
'C5B001230',
'C5B001232',
'C5B001233',
'C5B001234',
'C5B001235',
'C5B001236',
'C5B001237',
'C5B001242',
'C5B001243',
'C5B001244',
'C5B001250',
'C5B001251',
'C5B001252',
'C5B001253',
'C5B001254',
'C5B001255',
'C5B001256',
'C5B001257',
'C5B001258',
'C5B001259',
'C5B001260',
'C5B001261',
'C5B001262',
'C5B001263',
'C5B001264',
'C5B001265',
'C5B001266',
'C5B001267',
'C5B001268',
'C5B001269',
'C5B001270',
'C5B001271',
'C5B001272',
'C5B001273',
'C5B001274',
'C5B001275',
'C5B001276',
'C5B001277',
'C5B001278',
'C5B001279',
'C5B001280',
'C5B001281',
'C5B001282',
'C5B001283',
'C5B001284',
'C5B001285',
'C5B001286',
'C5B001287',
'C5B001288',
'C5B001289',
'C5B001290',
'C5B001292',
'C5B001293',
'C5B001294',
'C5B001295',
'C5B001296',
'C5B001297',
'C5B001298',
'C5B001299',
'C5B001300',
'C5B001303',
'C5B001304',
'C5B001305',
'C5B001306',
'C5B001307',
'C5B001308',
'C5B001309',
'C5B001310',
'C5B001312',
'C5B001313',
'C5B001314',
'C5B001315',
'C5B001317',
'C5B001318',
'C5B001321',
'C5B001322',
'C5B001323',
'C5B001324',
'C5B001326',
'C5B001327',
'C5B001328',
'C5B001329',
'C5B001330',
'C5B001331',
'C5B001332',
'C5B001333',
'C5B001334',
'C5B001335',
'C5B001336',
'C5B001337',
'C5B001338',
'C5B001339',
'C5B001340',
'C5B001341',
'C5B001342',
'C5B001343',
'C5B001344',
'C5B001345',
'C5B001346',
'C5B001347',
'C5B001348',
'C5B001349',
'C5B001351',
'C5B001352',
'C5B001353',
'C5B001354',
'C5B001355',
'C5B001356',
'C5B001357',
'C5B001358',
'C5B001359',
'C5B001360',
'C5B001362',
'C5B001363',
'C5B001364',
'C5B001365',
'C5B001366',
'C5B001367',
'C5B001368',
'C5B001369',
'C5B001370',
'C5B001371',
'C5B001372',
'C5B001373',
'C5B001374',
'C5B001375',
'C5B001376',
'C5B001377',
'C5B001378',
'C5B001380',
'C5B001381',
'C5B001382',
'C5B001383',
'C5B001384',
'C5B001386',
'C5B001387',
'C5B001388',
'C5B001389',
'C5B001390',
'C5B001391',
'C5B001394',
'EOQ000569',
'EOQ000602',
'EOQ000603',
'EOQ000618',
'EPQ000347',
'EPQ000348',
'EPQ000349',
'EPQ000402',
'EPQ000409',
'EPQ000410',
'EPQ000411',
'EPQ000412'
)
 group by o.ProductionOrderNumber, l.Description, l.Location, o.ActualStartTime, o.ActualFinishTime, 
 lo.LineQuantity, lo.ReadyQuantity, sd.LotCode,  sd.FirstSensorSerial, sd.LastSensorSerial
 order by o.ProductionOrderNumber, sd.LotCode


